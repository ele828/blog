<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Eric's Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/img/favicon.png"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/reset.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-79167899-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">ERIC HUANG</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">ARCHIVE</a></li><li class="menu-item"><a href="/gallery/" target="_self">GALLERY</a></li><li class="menu-item"><a href="/about/" target="_self">ABOUT</a></li></ul></div></nav><main class="prince-container"><div class="header"><div><h1 class="post-title">Monorepo Practice</h1><div class="post-info">Mar 7th 2018</div></div></div><div class="post"><article class="post-block"><div class="post-entry"><h1 id="Monorepo-Practice"><a href="#Monorepo-Practice" class="headerlink" title="Monorepo Practice"></a>Monorepo Practice</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>When dealing with large projects containing several shared libraries, it’s usually tricky to contribute code across multiple repositories. Things even become harder when you have to handle both public and private repositories that have dependent relationships, or those dependent repositories are on different platforms. Below is a solution based on the Monorepo approach and git subrepo, which is trying to make it easier to manipulate across multiple repositories.</p>
<h2 id="Convention"><a href="#Convention" class="headerlink" title="Convention"></a>Convention</h2><h3 id="Folder-Structure"><a href="#Folder-Structure" class="headerlink" title="Folder Structure"></a>Folder Structure</h3><p>In order to keep consistent with other Monorepos, it’s recommended to follow the designated folder structure.</p>
<pre><code>.
├── LICENSE
├── README.md
├── lerna.json
├── package.json
├── packages
│   ├── main-repo
│   ├── ringcentral-integration
│   └── ringcentral-widgets
└── yarn.lock
</code></pre><p>All subrepos should be placed in <code>pakages</code> folder, including the original mainrepo. In this way, it’s much more straightforward to manage.</p>
<h3 id="Git-Subrepo"><a href="#Git-Subrepo" class="headerlink" title="Git Subrepo"></a>Git Subrepo</h3><p>It’s highly recommended to use <code>git subrepo</code> to take control of your subrepo. <code>git-subrepo</code> is an open source tool,  which leverages <strong>git hash objects</strong> to manage subrepos. It’s much easier to getting along with than <code>git subtree</code>, if follow workflows below, you will never run into unexpected circumstances.</p>
<h3 id="Lerna"><a href="#Lerna" class="headerlink" title="Lerna"></a>Lerna</h3><p>Since there will be serveral subrepo projects inside current main repo, it becomes harder to operate across subrepos, here is where Lerna comes into play. By using Lerna, you can easily run any shell commands and npm scripts in subrepos, Lerna also presents bunch of useful features that can help you out.</p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><ol>
<li>Install <code>git subrepo</code>, if on Mac, you can install git-subrepo by running<br><code>brew install git-subrepo</code></li>
</ol>
<p>Otherwise, follow installation instructions on  <a href="https://github.com/ingydotnet/git-subrepo" target="_blank" rel="noopener">Git Subrep</a> docs.</p>
<ol>
<li><p>Clone remote project into <strong>subfolder</strong>, run<br><code>git subrepo clone &lt;remote-url&gt; packages/&lt;subdir&gt;</code></p>
</li>
<li><p>Move files in main repo to a <strong>subfolder</strong>.</p>
</li>
<li>Put configuration files needed in the root folder, update legacy configurations, e.g. <code>.gitignore</code>.</li>
<li>Set up Lerna, create bunch of npm scripts to run <strong>boostrap</strong>, <strong>build</strong>, <strong>test</strong> etc.</li>
<li>Set up development env by using <code>alias</code>, so that you can develop directly across multiple projects.</li>
<li>Finally, we get there!</li>
</ol>
<h2 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h2><p>After everything is set up, it’s now ready to get to day-to-day work. Since we have to manipulate several subrepos coordinately, the <strong>git flow</strong> would be a bit tricky, so the following graph shows a recommended subrepo workflow:</p>
<p><img src="/images/monorepo_structure.png" alt="Monorepo Structure"></p>
<p>This is an overview of Repository Relationships and overall action path, the graph below describes 3 action paths:</p>
<p><img src="/images/monorepo_flow.png" alt="Monorepo Flow"></p>
<h3 id="Before-Sprint"><a href="#Before-Sprint" class="headerlink" title="Before Sprint"></a>Before Sprint</h3><p>You usually need to pull changes from subrepo remote to keep subrepo up to date. Follow <strong>Pull Subrepo</strong> instruction.</p>
<h3 id="During-Sprint"><a href="#During-Sprint" class="headerlink" title="During Sprint"></a>During Sprint</h3><ul>
<li><p><strong>Daily work</strong><br>Follow <strong>Contribute</strong> instruction.</p>
</li>
<li><p><strong>Sync up with remote subrepo</strong><br>Sometimes you want to pull or push subrepo changes to perform special operations, in this case, you can follow <strong>Pull Subrepo</strong> and <strong>Push Subrepo</strong> instruction.</p>
</li>
</ul>
<h3 id="After-Sprint"><a href="#After-Sprint" class="headerlink" title="After Sprint"></a>After Sprint</h3><p>Push subrepo changes to subrepo remote. Follow <strong>Push Subrepo</strong> instruction.</p>
<blockquote>
<p>Note: Subrepo push is a bit different, you need to use <code>git subrepo push &lt;subdir&gt; -r &lt;remote&gt; -b &lt;remote-branch&gt;</code> to push commits to your own fork instead of pushing directly to remote main repo.  </p>
</blockquote>
<h2 id="Precautions"><a href="#Precautions" class="headerlink" title="Precautions"></a>Precautions</h2><ul>
<li><strong>Do</strong> pull from remote repo after pushed to ensure tree hash is exactly the same as remote one, this is really essential, otherwise next time when you do <code>git subrepo push</code>, git subrepo can <strong>not</strong> find correct commit ancestor, which will mess up your commits by including too many legacy commits.</li>
</ul>
<ul>
<li><strong>Do NOT</strong> merge code to main repo when someone is syncing code with subrepo remote, otherwise it will cause <code>git-subrepo</code> to find a wrong common ancestors, which will include dirty commits next time you push.</li>
</ul>
<ul>
<li><strong>Do</strong> ensure that the tree hash is correct after pull from remote repo. You can use <code>git subrepo branch</code> to check the tree hash.</li>
<li>Better <strong>Do NOT</strong> pull from remote when current branch is not clean, because it will make tree hash different from remote at this point and a bit hard to figure out what’s going on here, but it won’t actually prevent you from pushing code back. The recommended way to pull from subrepo remote is to do it in a new clean branch.</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://github.com/ingydotnet/git-subrepo" target="_blank" rel="noopener">Git Subrep</a></li>
<li><a href="https://github.com/ingydotnet/git-subrepo/wiki" target="_blank" rel="noopener">Git Subrepo Principle</a></li>
<li><a href="https://git-scm.com/book/en/v2/Git-Internals-Git-Objects" target="_blank" rel="noopener">Git Internals - Git Objects</a></li>
</ul>
</div></article></div><div class="post-nav"><div class="next-wrap col-md-6 col-xs-6 col-md-offset-6 col-xs-offset-6"><a href="/blog/2017/03/21/Facebook面试小记/" class="next-post">Facebook面试小记</a><i class="fa fa-angle-double-right"></i></div></div></main></div><footer><div class="copyright"><p>Crafted with <i class="fa fa-heart"></i> by&nbsp;ERIC HUANG&nbsp;|&nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yiliashaw/hexo-theme-prince" target="_blank">Prince</a></p></div></footer><script src="/js/jquery-3.2.1.min.js"></script><script src="/js/bootstrap.min.js"></script><link href="/fancybox/jquery.fancybox.min.css" rel="stylesheet"><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script><script src="/js/gist-embed.min.js"></script></body></html>